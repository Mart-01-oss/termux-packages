name: NeonIDE - Publish prebuilt .deb(s) to pages APT repo

on:
  workflow_dispatch:
    inputs:
      deb_artifact_name:
        description: "Name of the uploaded artifact that contains .deb files (leave as-is if using artifact upload)"
        required: true
        default: "prebuilt-debs"
      deb_file_path:
        description: "Optional: path to a single .deb already present in this repo checkout (e.g. cmake_4.2.2_aarch64.deb). If set, artifact/URL download steps are skipped."
        required: false
        default: ""
      deb_url:
        description: "Optional: direct URL to a .deb (e.g. GitHub Release asset). If set, artifact download step is skipped."
        required: false
        default: ""
      deb_url_sha256:
        description: "Optional: expected SHA256 for deb_url (integrity check)."
        required: false
        default: ""
      apt_dist:
        description: "APT distribution (dists/<dist>)"
        required: false
        default: "stable"
      apt_component:
        description: "APT component (pool/<component>)"
        required: false
        default: "main"
      apt_arch:
        description: "APT arch directory (binary-<arch>)"
        required: false
        default: "aarch64"
      large_deb_threshold_mb:
        description: "Treat debs >= this size (MiB) as large and publish via GitHub Release assets"
        required: false
        default: "99"
      force_overwrite:
        description: "Overwrite existing debs even if different"
        required: false
        type: boolean
        default: false
      expected_packages:
        description: "Optional: space/newline-separated list of package names expected to be published (others will be skipped)."
        required: false
        default: ""
      fail_on_recipe_mismatch:
        description: "Fail if recipe metadata (maintainer/homepage) mismatches deb control fields."
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout termux-packages
        uses: actions/checkout@v5

      - name: Install host tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends dpkg-dev gzip ca-certificates git gnupg gh jq

      - name: Download prebuilt deb artifact
        if: ${{ inputs.deb_file_path == '' && inputs.deb_url == '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.deb_artifact_name }}
          path: prebuilt-debs

      - name: Download .deb from URL
        if: ${{ inputs.deb_file_path == '' && inputs.deb_url != '' }}
        run: |
          set -euo pipefail
          mkdir -p prebuilt-debs
          url='${{ inputs.deb_url }}'
          echo "Downloading: $url"
          fname="$(basename "$url")"
          curl -LfsS "$url" -o "prebuilt-debs/$fname"
          echo "Downloaded sha256: $(sha256sum "prebuilt-debs/$fname" | awk '{print $1}')"

          if [ -n '${{ inputs.deb_url_sha256 }}' ]; then
            echo "Verifying sha256..."
            echo "${{ inputs.deb_url_sha256 }}  prebuilt-debs/$fname" | sha256sum -c -
          fi

      - name: Stage single .deb (deb_file_path)
        if: ${{ inputs.deb_file_path != '' }}
        run: |
          set -euo pipefail
          mkdir -p prebuilt-debs
          src="${{ github.workspace }}/${{ inputs.deb_file_path }}"
          if [ ! -f "$src" ]; then
            echo "::error ::deb_file_path not found: $src"
            exit 1
          fi
          cp -f "$src" prebuilt-debs/

      - name: List downloaded/staged files
        run: |
          set -euo pipefail
          find prebuilt-debs -type f -name "*.deb" -print || true
          ls -lah prebuilt-debs || true

      - name: Import repo signing key (optional)
        env:
          NEONIDE_GPG_PRIVATE_KEY_B64: ${{ secrets.NEONIDE_GPG_PRIVATE_KEY_B64 }}
          NEONIDE_GPG_KEY_ID: ${{ secrets.NEONIDE_GPG_KEY_ID }}
        run: |
          set -euo pipefail
          if [ -z "${NEONIDE_GPG_PRIVATE_KEY_B64:-}" ] || [ -z "${NEONIDE_GPG_KEY_ID:-}" ]; then
            echo "No signing key configured (NEONIDE_GPG_PRIVATE_KEY_B64/NEONIDE_GPG_KEY_ID missing). Repo will be unsigned."
            exit 0
          fi

          echo "$NEONIDE_GPG_PRIVATE_KEY_B64" | base64 -d | gpg --batch --import
          echo "Secret key is available."
          gpg --batch --list-secret-keys --keyid-format=long "$NEONIDE_GPG_KEY_ID" | sed -n '1,120p'

      - name: Checkout pages repo
        env:
          PAGES_PAT: ${{ secrets.PAGES_PAT }}
        run: |
          set -euo pipefail
          if [ -z "${PAGES_PAT:-}" ]; then
            echo "::error ::Missing secret PAGES_PAT (needs push access to Mart-01-oss/pages.git)"
            exit 1
          fi
          rm -rf pages-repo
          git clone "https://x-access-token:${PAGES_PAT}@github.com/Mart-01-oss/pages.git" pages-repo

      - name: Publish large debs to GitHub Release as flat APT repo (Packages/Release)
        env:
          # Use the same PAT we already require for pushing pages-repo; it must also have
          # permission to manage releases in Mart-01-oss/pages.
          GH_TOKEN: ${{ secrets.PAGES_PAT }}
          DEBS_DIR: ${{ github.workspace }}/prebuilt-debs
          LARGE_DEB_THRESHOLD_MB: ${{ inputs.large_deb_threshold_mb }}
          RELEASE_REPO: Mart-01-oss/pages
          RELEASE_TAG: Package
          APT_ARCH: ${{ inputs.apt_arch }}
          NEONIDE_GPG_KEY_ID: ${{ secrets.NEONIDE_GPG_KEY_ID }}
          NEONIDE_GPG_PASSPHRASE: ${{ secrets.NEONIDE_GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          bash ./scripts/neonide-publish-large-debs-to-release.sh

      - name: Filter small debs for Pages repo publish
        run: |
          set -euo pipefail
          threshold_mb='${{ inputs.large_deb_threshold_mb }}'
          threshold_bytes=$((threshold_mb*1024*1024))
          rm -rf small-debs
          mkdir -p small-debs

          # Copy only debs smaller than threshold into small-debs/
          while IFS= read -r -d '' f; do
            size="$(stat -c%s "$f")"
            if [ "$size" -lt "$threshold_bytes" ]; then
              cp -f "$f" small-debs/
            fi
          done < <(find prebuilt-debs -type f -name '*.deb' -print0)

          echo "Small debs staged for Pages repo:"
          ls -lah small-debs || true

      - name: Publish debs into pages APT repo (small debs only; no large deb indexes)
        env:
          PAGES_REPO_DIR: ${{ github.workspace }}/pages-repo
          # Publish only small debs copied into small-debs/
          DEBS_DIR: ${{ github.workspace }}/small-debs
          APT_DIST: ${{ inputs.apt_dist }}
          APT_COMPONENT: ${{ inputs.apt_component }}
          APT_ARCH: ${{ inputs.apt_arch }}
          FORCE_OVERWRITE: ${{ inputs.force_overwrite && 'true' || 'false' }}
          EXPECTED_PACKAGES: ${{ inputs.expected_packages }}
          FAIL_ON_RECIPE_MISMATCH: ${{ inputs.fail_on_recipe_mismatch && 'true' || 'false' }}
          # Large debs are handled by the Release repo step; Pages repo should not reference them.
          NEONIDE_LARGE_DEB_PUBLISH_MODE: pages
          NEONIDE_LARGE_DEB_THRESHOLD_MB: ${{ inputs.large_deb_threshold_mb }}
          # Do not prefix relative Filename entries with "./" in Packages.
          NEONIDE_PACKAGES_PREFIX_DOTSLASH: "false"
          NEONIDE_GPG_KEY_ID: ${{ secrets.NEONIDE_GPG_KEY_ID }}
          NEONIDE_GPG_PASSPHRASE: ${{ secrets.NEONIDE_GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          bash ./scripts/neonide-publish-prebuilt-debs.sh

      - name: Commit & push pages repo changes (if any)
        env:
          PAGES_PAT: ${{ secrets.PAGES_PAT }}
        run: |
          set -euo pipefail
          cd pages-repo
          if [ -z "$(git status --porcelain=v1)" ]; then
            echo "No changes to push."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Publish prebuilt debs (${{ inputs.deb_artifact_name }})"
          git push origin main
